version: '3.8'

services:
  # MongoDB service
  mongodb:
    image: mongo:7.0
    container_name: youtube_mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: youtube_data
    volumes:
      - mongodb_data:/data/db
      - ./mongodb-init:/docker-entrypoint-initdb.d
    networks:
      - youtube_network

  # MongoDB Express for web interface
  mongo-express:
    image: mongo-express:1.0.0
    container_name: youtube_mongo_express
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: password123
      ME_CONFIG_MONGODB_URL: mongodb://admin:password123@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
      ME_CONFIG_BASICAUTH: true
    depends_on:
      - mongodb
    networks:
      - youtube_network

  # FastAPI YouTube Data Service
  youtube-api:
    image: python:3.11-slim
    container_name: youtube_fastapi
    restart: always
    ports:
      - "8000:8000"
    environment:
      - YOUTUBE_API_KEY=AIzaSyAr6B9F18e9vrR5_5sp4dDIVulnup3cqXc
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_USERNAME=admin
      - MONGO_PASSWORD=password123
      - MONGO_DATABASE=youtube_data
      - PYTHONPATH=/app:/app/Keys
    volumes:
      - ./Keys:/app/Keys
      - ./data:/app/data
      - ./requirements-api.txt:/app/requirements-api.txt
    working_dir: /app
    command: |
      bash -c "
      pip install -r requirements-api.txt &&
      cd Keys/Api &&
      uvicorn main:app --host 0.0.0.0 --port 8000 --reload
      "
    depends_on:
      - mongodb
    networks:
      - youtube_network

  # Airflow Standalone (SQLite backend)
  airflow-standalone:
    image: apache/airflow:2.7.3-python3.11
    container_name: youtube_airflow
    restart: always
    ports:
      - "8080:8080"
    environment:
      - AIRFLOW__CORE__EXECUTOR=SequentialExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////opt/airflow/airflow.db
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
      - AIRFLOW__CORE__PLUGINS_FOLDER=/opt/airflow/plugins
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__WEBSERVER__EXPOSE_CONFIG=True
      - YOUTUBE_API_KEY=AIzaSyAr6B9F18e9vrR5_5sp4dDIVulnup3cqXc
      - YOUTUBE_CHANNEL_HANDLE=MrBeast
      - MONGO_HOST=mongodb
      - MONGO_PORT=27017
      - MONGO_USERNAME=admin
      - MONGO_PASSWORD=password123
      - MONGO_DATABASE=youtube_data
      - DATA_STAGING_PATH=/data/staging/
      - PYTHONPATH=/opt/airflow
    volumes:
      - ./dags:/opt/airflow/dags
      - ./plugins:/opt/airflow/plugins
      - ./config:/opt/airflow/config
      - ./soda:/opt/airflow/soda
      - ./data:/data
      - airflow_data:/opt/airflow
    command: |
      bash -c "
      pip install pymongo requests python-dotenv isodate &&
      airflow db init &&
      airflow users create --username admin --firstname Admin --lastname User --role Admin --email admin@example.com --password admin &&
      airflow scheduler &
      airflow webserver
      "
    depends_on:
      - mongodb
    networks:
      - youtube_network

volumes:
  mongodb_data:
    driver: local
  airflow_data:
    driver: local

networks:
  youtube_network:
    driver: bridge
